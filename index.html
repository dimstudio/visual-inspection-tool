<!doctype html>
<html class="no-js" lang="">
<head>
    <meta charset="utf-8">
    <meta http-equiv="x-ua-compatible" content="ie=edge">
    <title>Visual Inspection Tool</title>
    <meta name="description" content="${2}">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="css/normalize.min.css">
    <link rel="shortcut icon" type="image/png" href="css/favicon.ico"/>
    <script src="js/modernizr.min.js"></script>
    <script src="js/plotly-latest.min.js"></script>
    <script src="js/jquery-1.12.4.min.js"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/jqueryui/1.10.3/jquery-ui.min.js"></script>
    <script>window.jQuery || document.write('<script src="js/vendor/jquery-1.12.4.min.js"><\/script>')</script>
    <link href="css/c3.css" rel="stylesheet">
    <script src="js/d3.js"></script>
    <script src="js/c3.js"></script>
    <link rel="stylesheet" href="css/bootstrap.min.css">
	<script src="js/bootstrap.min.js"></script>
	<script type="text/javascript" src="js/jszip.min.js"></script>
	<script type="text/javascript" src="js/moment.js"></script>
	<script type="text/javascript" src="js/jszip-utils.min.js"></script>
	<link rel="stylesheet" href="css/jquery.tree-multiselect.css">
	<script type="text/javascript" src="js/jquery.tree-multiselect.min.js"></script>
	<!--[if IE]>
		<script type="text/javascript" src="js/jszip-utils-ie.min.js"></script>
	<![endif]-->
		
    <style>
		.c3-region.rated {fill: yellow; stroke: #ffcc00; stroke-width:1}
		.c3-region.selected {fill: blue; stroke: blue; stroke-width:1}
		.c3-xgrid-line.currentTime line {stroke: red; stroke-width:2}
		div.tree-multiselect > div.selections {width: 100%}
		#attrTree {padding-right: 0;}
		#plotsContainer {padding-left: 0;}
		div.tree-multiselect > div.selections.no-border {max-height: 500px; overflow-y: scroll;}
		#wrapper {padding: 0 40px 0 20px;}
		div.section > div.section, div.tree-multiselect div.section > div.item {padding-left: 5px;}
		.smallInput {/*width:18%;*/ width: 35%; float: left; margin-right:5px;}
		.zoomInput {width:35%; float: left; margin-right:5px;}
		div.tree-multiselect { border: 0px;}
		.howTo {background: #FFF url('css/how-to-use.png'); background-repeat: no-repeat; background-position: top center; opacity: .5; background-size: 75%; }
		.form-group { margin-bottom: 0px;}
		#keyValuePairList input {margin-top:5px;}
		#keyValuePairList {display: inline-block; width: 100%;}
		#keyValuePairList label {display: block; float: left; width: 36%; font-weight: 700; padding: 10px 0 0;}
		div.deleteKeyValueLink { margin-top: 10px; float: right;}
	</style>
</head>
<body>
<div id="wrapper">

	<div class="row" style="padding-left:20px;"	>
		<div class="col-sm-8">
	  		<h3>Visual Inspection tool <small>Multimodal data dasbhoard</small></h3>
		</div>
		<div class="col-sm-4" >
			<br />
			<p class="small" style="text-align: right;">Version 1.2 - Credits: <a href="http://www.dimstudio.org" target="_blank">Daniele Di Mitri</a> - Open Universiteit (<a href="https://creativecommons.org/licenses/by-sa/4.0/" target="_blank">CC BY-SA 4.0</a>)</p>
		</div>
	</div>
	<div class="row">
	  	<div class="col-sm-6" id="secondDiv">
		  	<div class="panel panel-default">
		  		<div class="panel-heading panel-footer">
				    <h3 class="panel-title ">Session loader <small>use .zip files</small></h3>
				</div>
			  	<div class="panel-body">	
				  	<form>
					  	<div class="row">
						    <div class="col-sm-6" >
						      <input type="file" id="theFile"  class="custom-file-input"> 
						    </div>
							<div id="theFileList" class="col-sm-6"></div>
							
						</div>
					</form>
				</div>
			</div>
			<div class="col-sm-5" style="padding:0;">
			    <div class="panel panel-default">
				   	<div class="panel-heading panel-footer">
					    <h3 class="panel-title ">Intervals</h3>
					</div> 	
					<div class="panel-body">
					   	<input type="text" readonly class="form-control input-sm zoomInput" id="interval" placeholder="Zoom into the plot legend">
					    <button type="button" id="addinterval" class="btn btn-success btn-sm">Add interval</button>
					    <button type="button" class="btn btn-danger btn-sm" id="delete-button">Delete</button>
					    <select id="intervalList"></select>
				    </div>
			    </div>
			</div>
			<div class="col-sm-7" style="padding-right:0;">
				    <div class=" panel panel-default">
				    	<div class="panel-heading panel-footer">
						    <h3 class="panel-title ">Annotations</h3>
						</div>
				    	<div class="panel-body">
					    	<input type="text" class="form-control input-sm smallInput" id="inputKey" placeholder="Annotation label" required>
					    	<input type="text" class="form-control input-sm smallInput" id="inputDefaultValue" placeholder="Defualt value" required>
					    	<button type="button" id="addKeyValuePair" class="btn btn-success btn-sm">Add</button> 			
					    	<form id="keyValuePairForm">
				    			<div id="keyValuePairList"></div>
				    		</form>
				    		<div>
				    			<button type="button" class="btn btn-default btn-sm" >Add to plot </button>
				    			<button type="button" id="exportJSON" class="btn btn-primary btn-sm">JSON</button>
				    			<a href="" download="annotations.json" id="downloadJSON"></a>
				    		</div>
				    	</div>
				    </div>
			</div>

				  	<!--<div class="form-group row">
			  			<div class="col-sm-12">
			  				<input type="text" class="form-control smallInput" id="inputTimestamp" placeholder="Time" required>
					      	<input type="text" class="form-control smallInput" id="inputActor" placeholder="Actor" style="" required>
					      	<input type="text" class="form-control smallInput" id="inputVerb" placeholder="Verb" required>
					      	<input type="text" class="form-control smallInput" id="inputObject" placeholder="Object" required>
					    	<input type="text" class="form-control smallInput" id="inputResult" placeholder="Result" required>
					    </div>
			  		</div>

					<div class="form-group row">
			  			<div class="col-sm-12" id="xAPIForm">
					      	<input type="text" class="form-control smallInput" id="inputAuthority" placeholder="Authority">
					      	<button type="button" id="exportXAPI" class="btn btn-primary right">Export xAPI</button>
					      	<a href="" download="xAPIlist.json" id="downloadJSON"></a>
					    </div>
			  		</div>-->				  		
			  		<div class="row">
				  		
				  	</div>
		</div>
		<div class="col-sm-6" id="theVideo">
		</div>
	</div>	
	<div class="row">	
		<div class="col-sm-2" >
			<div class="panel panel-default">
				<div class="panel-heading panel-footer">
					 <h3 class="panel-title" style="float: left; margin-right: 10px;">Attribute list</h3> <small><input type="checkbox" id="attrNormalize" />&nbsp;&nbsp;[-1, 1]</small>
				</div>
				<div class="small" style="padding-left: 10px"> </div>
				<div id="attrTree">
					<select id="attrTreeSelect" multiple="multiple"></select>
				</div>
			</div>
		</div>
	  	<div class="col-sm-10" id="plotsContainer" style="min-height: 400px;">
			<div id="plotGraph"></div>
		</div>
	</div>
</div>	
</body>
<script>
 
	// globalValues 
	var $result = $("#theFileList");
	var $video;
	var attrDict; 
	var regions;
	var annObjLen;
	var annTf = 0.5; // annotatoom timeframe
	var sessionName; 

	$("#theFile").on("change", function (evt) {
		// remove content
		$result.html("");
		attrDict = {};
		$("#interval").val("");
		$("#intervalList").find('option').remove();
		intervalList.reload();
		$('#attrTreeSelect').find('option').remove();
		treeAttributes.reload();
		treeOnChange();
		$("a#downloadJSON").html("").attr("href","");
		$("#theVideo video").remove();
		$("#theVideo").html("<video style='width:100%;' controls=''></video>");
		$video = $("#theVideo video");
		regions = [];
		var chart;
		annObjLen = 0;
		//$sessionName = "";

		// be sure to show the results
		$("#result_block").removeClass("hidden").addClass("show");

		// Closure to capture the file information.
		var appCounter = 0;	
		// populate the AttributeList
		function handleFile(f) {
			var $title = $("<strong>", {
				text: f.name
			});
			var $fileContent = $("<ul>");
			sessionName = f.name;
			$result.append($title);
			$result.append($fileContent);

			
			var dateBefore = new Date();
			JSZip.loadAsync(f).then(function (zip) {
					attrDict = {};
					var dateAfter = new Date();
					$title.append($("</strong><span>", {
						"class": "small",
						text: " (loaded in " + (dateAfter - dateBefore) + "ms)"
					}));

					zip.forEach(function (relativePath, zipEntry) {  // 2) print entries
						$fileContent.append($("<li>", {
							text: zipEntry.name
						}));
						
						// Load the .mp4 file into the player
						if (zipEntry.name.includes(".mp4")) {	
							zipEntry.async("blob").then(function (content) { 
								var binaryVideo = [];
								binaryVideo.push(content);
								var source = document.createElement('source');
							    source.src = window.URL.createObjectURL(new Blob(binaryVideo));
							    source.type = "video/mp4";
							    $video.append(source);
							});
						}

						// Load the .JSON file into the plot
						if (zipEntry.name.includes(".json")) {
							zipEntry.async("text").then(function (content) {
								appCounter = appCounter + 1;
								addToAttrDict(content, appCounter);
								treeAttributes.reload();
							});
						}

					});
				}, function (e) {
					$result.append($("<div>", {
						"class": "alert alert-danger",
						text: "Error reading " + f.name + ": " + e.message
					}));
				});	
		}
		var files = evt.target.files;
		for (var i = 0; i < files.length; i++) {
			handleFile(files[i]);
		}
	});

	function addToAttrDict (json_flat, appCounter) {
		json_object = JSON.parse(json_flat);		
		var applicationName = json_object.applicationName;
		var attr;
		tempAttrDict = {}
		for (i in json_object.frames) {
			for (j in json_object.frames[i].frameAttributes) {
				if (!(j in tempAttrDict)) {
					tempAttrDict[j] = {};
				}
				tempAttrDict[j][json_object.frames[i].frameStamp.substring(6,12)] = json_object.frames[i].frameAttributes[j];
			}	
		}
		for (i in Object.keys(tempAttrDict)){
			//console.log(Object.keys(tempAttrDict)[i]+" "+sum(tempAttrDict[Object.keys(tempAttrDict)[i]]));
			attr = Object.keys(tempAttrDict)[i];
			first = attr.substring(0,1)
			last = attr.substring(attr.length-1);
			if (sum(tempAttrDict[attr])!=0 && !isNaN(sum(tempAttrDict[attr]))){
				if (applicationName=='Kinect' && parseFloat(first)>0){
					if (last=="X" || last=="Y" || last=="Z") { 
						html = "<option value='"+attr+"' data-section='"+applicationName+"/"+first+"/"+attr.substring(1,attr.length-1)+"'>"+last+	"</option>";
					} else {
						html = "<option value='"+attr+"' data-section='"+applicationName+"/"+first+"'>"+attr.substring(1)+"</option>";
					}
					$("#attrTreeSelect").append(html);
				} else {
					$("#attrTreeSelect").append("<option value='"+attr+"' data-section='"+applicationName+"'>"+attr+"</option>");
				}
			}
		}
		attrDict = Object.assign(attrDict, tempAttrDict);
		//console.log(JSON.stringify(attrDict));
		
		// Determine max time-length (max key for each attribute in the attrDict)
		for (i in attrDict){
			if (getMax(attrDict[i])> annObjLen){
				annObjLen = getMax(attrDict[i]);
			}

		}

	}

	// generatePlot (out of the AttributeList)

	function treeOnChange(allSelectedItems, addedItems, removedItems) {
		var xs = {};
		var columns = [];
		var keyMax = 0;
		var normalize = $("#attrNormalize").is(':checked');
		var attr;
		var arr;
		var xMax;
		var xMin;
		for (i in allSelectedItems){
			attr = allSelectedItems[i].value;
			if (sum(attrDict[attr])!=0 && !isNaN(sum(attrDict[attr]))){ 
				if (normalize){
					arr = Object.keys(attrDict[attr]).map(function (k) { return attrDict[attr][k]; });
					xMin = Math.min.apply( null, arr );
					xMax = Math.max.apply( null, arr );
					cols = $.map(attrDict[attr], function (value, key) { return (2*(value - xMin)/ (xMax - xMin))-1 });
				} else {
					cols = $.map(attrDict[attr], function (value, key) { return value });
				}
				cols.unshift(attr);
				rows = $.map(attrDict[attr], function (value, key) { return String(key)});
				max = rows[rows.length - 1];
				if (max > keyMax) {
					keyMax = max;
				}
				rows.unshift(attr + '_x');
				columns.push(cols);
				columns.push(rows);
				xs[attr] = attr + '_x';
			}
		}
		var xAxisTicks = [];
		var xscale = 5;
		if (keyMax > 0) {
			q = Math.floor(keyMax / xscale);
			for (i = 0; i <= (q * xscale); i = i + xscale) {
				xAxisTicks.push(i);
			}

		}
		generatePlot(xs,columns,xAxisTicks);
	}
	function generatePlot(xs,columns,xAxisTicks) {

		chart = c3.generate({
			bindto: '#plotGraph',
			data: {
				xs: xs,
				xFormat: '%S.%L',
				columns: columns,
				onclick: function (id) {
					$("#theVideo video")[0].currentTime=id.x;
				}
			},
			subchart: {
				show: true,
				onbrush: function (domain) {
					$('#interval').val(domain[0].toFixed(3) + ', ' + domain[1].toFixed(3));
				}
			},
			legend: {
				show: false
			},
			grid: {
				x: {show: true},
				y: {show: true}
			},
			zoom: {
				enabled: false,
				rescale: true,
				onzoom: function (domain) {
					$('#interval').val(domain[0].toFixed(3) + ', ' + domain[1].toFixed(3));
				}
			},
			axis: {
				x: {
					tick: {
						values: xAxisTicks
					},
					label: "Time (s)",
					min: 0
				},
				y: {
					tick: {
						format: d3.format('.2f')
					}
				}
			},
			size: {
				height: 500
			},
			padding:{
				top:20
			}

		});
		chart.regions(regions);

		$("#theVideo video").on("timeupdate",
			function (event) {
				chart.xgrids([{
					value: this.currentTime,
					class: 'currentTime'
			}]);
		});
		if ($.isEmptyObject(xs)){
			$("#plotGraph").addClass('howTo');
		} else {
			$("#plotGraph").removeClass('howTo');
		}

	 }//end generate plot


	 // ATTRIBUTE LIST
	 var treeAttributes = $("#attrTreeSelect").treeMultiselect({
			allowBatchSelection: true,
			onChange: treeOnChange,
			startCollapsed: true,
			hideSidePanel: true,
			//searchable: true
		})[0];

	var intervalList = $("#intervalList").treeMultiselect({
			allowBatchSelection: true,
			onChange: intervalsOnChange,
			startCollapsed: false,
			hideSidePanel: true,
			//searchable: true
		})[0];


	$("#addinterval").unbind().click(function () {
		if ($("#interval").val()){
			var arr = $("#interval").val().split(", "),
				begin = arr[0], stop = arr[1];
			regions.push({ axis: 'x', start: begin, end: stop, class: 'rated' });
			$("#intervalList").append("<option value='"+begin+", "+stop+"' data-section='intervals'>"+begin+"s to "+stop+"s</option>");
			intervalList.reload();
			chart.regions(regions);	
		}
	});

	$("#delete-button").click(function(){
	    if(confirm("Are you sure you want to delete all the selected intervals?")){
	        var values = $("#intervalList option:selected").map(function() { return $(this).val(); });
	        for (i in values){
	        	if(values[i].length>5){
	        		for (k in regions){
			        	if (regions[k].start == values[i].split(', ')[0] && regions[k].end == values[i].split(', ')[1]){
			        		regions.splice(k,1);
			        	}
			        }
	        	}
	        }
	        chart.regions(regions);
			$("#intervalList option:selected").remove();
			intervalList.reload();
	    }
	    else{
	        return false;
	    }
	});

	function intervalsOnChange(allSelectedItems, addedItems, removedItems) {
		var keys = [];
		var inter;
		var temp = {};
		$("input[name=inputKeyList]").each(function() { keys.push($(this).val()); });
		$("input[name=inputValueList]").val('').attr('placeholder','Add value');
		for (k in regions){
			regions[k].class = "rated";
		}
		for (i in allSelectedItems){
			inter = allSelectedItems[i].value;
			for (k in regions){
				if (regions[k].start == inter.split(', ')[0] && regions[k].end == inter.split(', ')[1]){			regions[k].class = "selected";
			        for (j in keys){
			        	if (regions[k].hasOwnProperty(keys[j])) {			
			        		if (!temp.hasOwnProperty(keys[j])) temp[keys[j]] = regions[k][keys[j]];
			        		if (regions[k][keys[j]] == temp[keys[j]]){
			        			$("input[name=inputKeyList][value="+keys[j]+"]").next().val(temp[keys[j]]);
			        		} else {
			        			$("input[name=inputKeyList][value="+keys[j]+"]").next().val('').attr('placeholder','?');
			        		}
			        	} else if (temp.hasOwnProperty(keys[j])){
			        		$("input[name=inputKeyList][value="+keys[j]+"]").next().val('').attr('placeholder','?');
			        	} else {
			        		temp[keys[j]] = '';
			        	}

			        } 
			    }
			}
		}
		// TODO if 
		chart.regions(regions);	
	}


	$("#addKeyValuePair").unbind().click(function () {
		var key = $("#inputKey").val();
		var dValue = $("#inputDefaultValue").val();
		if (key) {
			$("#keyValuePairList").append('<div class="keyValuePair"><label>'+key+'</label><input type="hidden" name="inputKeyList" value="'+key+'" /><input type="text" class="form-control input-sm smallInput" name="inputValueList" placeholder="Add value"/> <input type="hidden" name="inputValueDefault" value="'+dValue+'" /><div class="deleteKeyValueLink small">'+dValue+' (default) <a href="#" class="deleteKeyValuePair">[X]</a></div></div>');
			$("#inputKey").val('').removeAttr('value');
			$("#inputDefaultValue").val('').removeAttr('value');
		}

		$("a.deleteKeyValuePair").unbind().on('click', function (e) {
		    e.preventDefault();
		    if(confirm("Are you sure you want to delete this annotation pair?")){
		    	$(this).parent('div').parent('div').hide().remove();
		    }
		});
	});

	$("#keyValuePairForm").on("change", function (evt) {
		var inputKeys = [];
		var inputValues = [];
		var annotationList;
		var inter;

		$("input[name='inputKeyList']").each(function() { inputKeys.push($(this).val()); });
		$("input[name='inputValueList']").each(function() { inputValues.push($(this).val()); });
		if (inputKeys!=[]&&inputValues!=[]){
			annotationList = toObject(inputKeys,inputValues);
		}
		var interv = $('select#intervalList').val();
	    for (i in interv){
	    	inter = interv[i];
			for (k in regions){
				if (regions[k].start == inter.split(', ')[0] && regions[k].end == inter.split(', ')[1]){
					for (j in annotationList){
			        	regions[k][j] = annotationList[j]; //set
			        }
				}
			}
		}
	});

	$("#exportJSON").unbind().click(function () {
		var intervals = $("#intervalList").val();
		var keys = [];
		var values = [];
		var annotationList;
		var temp = false; 
		var inter;
		var jsonObj = {};
		var annObj = [];
		$("input[name='inputKeyList']").each(function() { keys.push($(this).val()); });
		$("input[name='inputValueDefault']").each(function() { values.push($(this).val());});
		annotationList = toObject(keys,values);
		if (!$.isEmptyObject(annotationList)){
			for (var i = 0; i < annObjLen/annTf; i++) {
				for (k in regions){
					if(regions[k].class='selected' && temp == false){
						if (i*annTf>=parseFloat(regions[k].start) && i*annTf<=parseFloat(regions[k].end)){
							for (j in keys){
								if (regions[k].hasOwnProperty(keys[j])){
									annotationList[keys[j]] = regions[k][keys[j]];
									temp = true;
								}
							}
						}
					}
				}
				annObj.push({
					frameStamp: moment.utc(i*annTf*1000).format('HH:mm:ss.SSS'),
					frameAttributes: annotationList
				});
				temp = false;
				annotationList = toObject(keys,values);
			}
			jsonObj["recordingID"] = sessionName;
			jsonObj["applicationName"] = "Annotations";
			jsonObj["frames"] = annObj;
			$("a#downloadJSON").html("Download JSON").attr("href","data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(jsonObj, 0, 4)));
		}
	});

	/*$("#exportXAPI").unbind().click(function () {
		console.log("export xapi started");
		var intervals = $("#intervalList").val();
		var attributes = $("#attrTreeSelect").val()
		console.log(attributes);
		var matchingKeys;
		var myKeys;
		//xapiVar 
		var newDict;
		var timestamp; 
		var actor;
		var verb;
		var object;
		var result;
		var authority;
		var contextExtentions;
		var xAPIObject = {};
		var xAPIlist = {};
		for (i in intervals) {
			start = parseFloat(intervals[i].split(",")[0]);
			stop = parseFloat(intervals[i].split(",")[1]);
			newDict = {};
			for (j in attributes){
				keys = Object.keys(attrDict[attributes[j]]);
				for (k in keys){
					if (keys[k]>=start && keys[k]<=stop) { 
						if (!(attributes[j] in newDict)) {
							newDict[attributes[j]] = {};
						}
						newDict[attributes[j]][keys[k]] = attrDict[attributes[j]][keys[k]];
					}
				}
			}

			// create xAPI 
			timestamp = $("#inputTimestamp").val();
			if (timestamp){
				xAPIObject['timestamp'] = timestamp;
			}
			xAPIObject['stored'] = moment().format('YYYY-MM-DThh:mm:ss.SSS');
			actor = $("#inputActor").val();
			if (actor){
				xAPIObject['actor'] = {};
				xAPIObject['actor']['name'] = actor;
			}
			verb = $("#inputVerb").val();
			if (verb){
				xAPIObject['verb'] = {};
				xAPIObject['verb']['id'] = verb;
			}
			object = $("#inputObject").val();
			if (object){
				xAPIObject['object'] = {};
				xAPIObject['object']['id'] = object;
			}
			result = $("#inputResult").val();
			if (result){
				xAPIObject['result'] = {};
				xAPIObject['result']['success'] = result;
			}
			authority = $("#inputAuthority").val();
			if (authority){
				xAPIObject['authority'] = authority;
			}
			contextExtentions = newDict;
			if (contextExtentions){
				xAPIObject['context'] = {};
				xAPIObject['context']['extensions'] = contextExtentions;
			}	
			xAPItitle = 'xapi_'+intervals[i].replace(', ','-');
			xAPIlist[xAPItitle] = xAPIObject;


		}
		$("a#downloadJSON").html("Download JSON").attr("href","data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(xAPIlist, 0, 4)));

	});*/

	// Sums the values of a dictionary
	function sum( obj ) {
	  var sum = 0;
	  for( var el in obj ) {
	    if( obj.hasOwnProperty( el ) ) {
	      sum += parseFloat( obj[el] );
	    }
	  }
	  return sum;
	}
	// Get the max key of a dicotionary
	function getMax(obj) {
	  return Math.max.apply(null,Object.keys(obj));
	}
	
	// merge 2 lists into dictionary
	function toObject(names, values) {
	    var result = {};
	    for (var i = 0; i < names.length; i++)
	         result[names[i]] = values[i];
	    return result;
	}
  </script>
</html>